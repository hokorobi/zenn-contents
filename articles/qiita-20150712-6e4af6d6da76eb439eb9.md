---
title: "æ›¸åº«ãƒ•ã‚¡ã‚¤ãƒ«ã®å±•é–‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ #PPx"
emoji: "ğŸ˜€"
type: "tech"
topics: [JScript,PPx]
published: false
published_at: 2015-07-12 03:14
---
[#PPx æ›¸åº«ãƒ•ã‚¡ã‚¤ãƒ«ã®å±•é–‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](http://d.hatena.ne.jp/hokorobi/20130602/1370178476) ã®ç„¼ãç›´ã—ã€‚
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã£ã½ãã—ã¦ã¿ãŸã€‚
ãƒã‚·ãªã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹ã¯ãšã€‚
ãƒ†ã‚¹ãƒˆã¯ã»ã¨ã‚“ã©ã—ã¦ã„ãªã„ã€‚

```js:unpack_7z.js
//!*script
// ç¬¬ä¸€å¼•æ•°: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
// ç¬¬äºŒå¼•æ•°: å±•é–‹å…ˆãƒ•ã‚©ãƒ«ãƒ€
//
// 7z ã‚’å®Ÿè¡Œã—ã¦å±•é–‹å…ˆãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ã™ã‚‹ã€‚
// æ›¸åº«ã‚’ãã®ã¾ã¾å±•é–‹ã—ãŸã¨ãã« 1 ãƒ•ã‚©ãƒ«ãƒ€ã«ã¾ã¨ã¾ã‚‹ã¨ãã¯ã€æ›¸åº«åãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ãªã„ã€‚
// 1 ãƒ•ã‚©ãƒ«ãƒ€ã«ã¾ã¨ã¾ã£ã¦ã„ãªã„ã¨ãã¯æ›¸åº«åãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã—ã¦ã€ãã®ä¸­ã«å±•é–‹ã™ã‚‹ã€‚
// åŒã˜åå‰ã®ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€-1 ãªã©ã‚’æœ«å°¾ã«è¿½åŠ ã—ãŸãƒ•ã‚©ãƒ«ãƒ€åã§å±•é–‹ã™ã‚‹ã€‚
// å±•é–‹ä¸­ã«åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã€ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã™ã‚‹ã€‚
// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ•ãƒ«ãƒ‘ã‚¹ã€"" æ‹¬ã‚Šãªã—ã§åˆ—æŒ™ã™ã‚‹ã€‚
//
// PPx 1.43+2 x64 + Script Module R14

if (PPx.Arguments.Length < 2) {
	linemessage('å¼•æ•°ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', false);
	PPx.Quit();
}

var UnpaQ = new Queue('unpackQueue');
UnpaQ.enqueue([PPx.Arguments.Item(0), PPx.Arguments.Item(1)]);

var Unpacking = new Cust('unpacking');

// å±•é–‹å‡¦ç†ä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒæ—¢ã«ã‚ã‚‹å ´åˆã€å½“è©²ãƒ—ãƒ­ã‚»ã‚¹ã¯åœæ­¢ã™ã‚‹ã€‚
if (Unpacking.get() != '') PPx.Quit();
Unpacking.set('prep');

for (var unpackset=UnpaQ.dequeue(); unpackset.length > 0; unpackset=UnpaQ.dequeue()) {
	var archives = new Archives(unpackset);
	archives.extract();
	delete archives;
}

Unpacking.clear();

function Archives(unpackset) {
	this.response = unpackset[0];
	this.folder = unpackset[1];

	this._getArchiveFiles = function() {
		try {
			var f = new ActiveXObject('ADODB.Stream');
			f.Type = 2;  // 1:ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ 2:ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
			f.Charset = 'UTF-8';  // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰è¨­å®š
			f.Open;
			f.LoadFromFile(this.response);  // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
			var archives = f.ReadText(-1).split(/\r\n/);
			f.Close();
		} catch (e) {
			linemessage('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚: ' + this.response);
			return [];
		}
		return archives;
	}

	this.extract = function() {
		var archives = this._getArchiveFiles();
		for (var i = 0; i < archives.length; i++) {
			var archive = new Archive(archives[i], this.folder);
			try {
				archive.extract();
			} catch (e) {
				linemessage(e.message);
				linemessage('å±•é–‹å¤±æ•—: ' + archive.file);
			}
			// delete archive;
		}
	}
}

function Queue(name) {
	this.name = name;
	this.cust = new Cust(this.name);

	this.enqueue = function(array) {
		var value = array.join('@'); // é †åºã®ä¿è¨¼ã¯ã‚ã‚‹ã®ã‹ãªï¼Ÿ
		var values = this.cust.get();
		values += (values == '') ? value : ';' + value;
		this.cust.set(values);
	};

	this.dequeue = function() {
		var values = this.cust.get();
		if (values == '') return [];

		var arrays = values.split(';');
		if (arrays.length == 0) return [];

		value = arrays[0];
		var array = value.split('@');

		arrays.splice(0, 1);
		if (arrays.length > 0) this.cust.set(arrays.join(';'));
		else this.cust.clear();

		return array;
	};

	this.clear = function() {
		this.cust.clear();
		delete this.cust;
	}
}

function Cust(name) {
	this.name = name;

	this.set = function(value) {
		PPx.Execute('*setcust _User:' + this.name + '=' + value);
	};
	this.clear = function() {
		this.set('');  // -| ã‚’ä½¿ã£ãŸã‚‰ _User ãŒã™ã¹ã¦æ¶ˆãˆãŸ
	};
	this.get = function() {
		return PPx.Extract('%*getcust(_User:' + this.name + ')');
	};
}

function Archive(file, folder) {
	this.file = file;
	this.folders = {target:folder, from:'', to:'', del:''};
	this.fso = new ActiveXObject('Scripting.FileSystemObject');

	this._getFolders = function() {
		var tempfolder = this.folders.from;
		var oTempFolder = this.fso.GetFolder(tempfolder);
		var oSubFolders = oTempFolder.SubFolders;

		// å±•é–‹ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ç›´ä¸‹ãŒãƒ•ã‚©ãƒ«ãƒ€ä¸€ã¤ã§ãªã„ãªã‚‰ç›´æ¥ç§»å‹•
		if (oTempFolder.files.Count > 0 || oSubFolders.Count > 1) return;

		// å±•é–‹ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ç›´ä¸‹ãŒãƒ•ã‚©ãƒ«ãƒ€ä¸€ã¤ãªã‚‰ã€ãã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç§»å‹•
		var e = new Enumerator(oSubFolders);  // ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« Enumerator ã‚’ä½¿ã†
		var oSubfolder = this.fso.GetFolder(e.item());
		this.folders['from'] = this.fso.BuildPath(tempfolder, oSubfolder.Name);
		this.folders['to'] = this.fso.BuildPath(this.folders.target, oSubfolder.Name);
		// åŒä¸€ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãŸå ´åˆã« -1 ãªã©ã‚’ä»˜åŠ ã™ã‚‹
		this.folders['to'] = PPx.Extract('%*name(DCNU, "' + this.folders.to + '")');
		this.folders['del'] = tempfolder;
		return;
	};

	this._moveFormalFolder = function() {
		// FIXME: æ›¸ãè¾¼ã‚ã¾ã›ã‚“ã€‚ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
		// ã¾ã ç™ºç”Ÿã™ã‚‹ï¼Ÿ
		this.fso.MoveFolder(this.folders.from, this.folders.to);
		if (this.folders['del'] == '') return;

		var oFolder = this.fso.GetFolder(this.folders.del);
		oFolder.Delete(true);
	};

	this.extract = function() {
		if (!this.fso.FolderExists(this.folders.target)) throw 'å±•é–‹å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚: ' + this.folders.target;

		do {
			var tempFolder = this.fso.BuildPath(this.folders.target, this.fso.GetTempName());
		} while (this.fso.FolderExists(tempFolder));

		Unpacking.set(this.file);
		var cmd;
		// å‡¦ç†ãŒå®Œäº†ã—ã¦ã„ãªã„ã¨ãƒ•ã‚©ãƒ«ãƒ€ã®ç§»å‹•ãŒã§ããªã„ã®ã§ %Os ã‚’ä½¿ã†ã€‚
		// PPb ã§å®Ÿè¡Œã™ã‚‹ã¨è¤‡æ•°å®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã†ã®ã§ %Ob ã‚’ä½¿ã†ã€‚
		cmd = "%Onbsq %'7z' x \"" + this.file;
		cmd += (this.file.match(/\.tar\.gz$|\.tgz$|\.tbz$|\.tar.bz2$|\.tar.xz$/)) ? "\" -bd -so | %'7z' x -ttar -si -o\"" : '" -bd -o"';
		cmd += tempFolder + '"';
		PPx.Execute(cmd);  // ã‚¨ãƒ©ãƒ¼ã‚’æ‹¾ãˆãªã„

		// å±•é–‹ã§ãã¦ã„ãªã‹ã£ãŸã‚‰å¤±æ•—ã¨ã™ã‚‹
		if (!this.fso.FolderExists(tempFolder)) {
			linemessage('å±•é–‹å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + tempFolder);
			linemessage('å±•é–‹å¤±æ•—: ' + this.file);
			return;
		}

		var formalFolder = this.fso.BuildPath(this.folders.target, this.fso.GetBaseName(this.file));
		this.folders['from'] = tempFolder;
		this.folders['to'] = formalFolder;
		this._getFolders();
		this._moveFormalFolder();
	};
}

function linemessage(message) {
	PPx.Execute('*execute C,*logwindow "unpack_7z: ' + message + '"');
}
```

